<!doctype html> 
<html lang="it"> 
<head> 
    <meta charset="UTF-8" />
    <title>Phaser 3 - Guida Completa per Principianti</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body { margin: 0; } /* Rimuove i bordi bianchi intorno al gioco */
    </style>
</head>
<body>

<script type="text/javascript">

    // --- 1. IL CERVELLO (CONFIGURAZIONE) ---
    // Questo oggetto dice a Phaser come impostare la finestra di gioco e quali leggi fisiche usare.
    var config = {
        type: Phaser.AUTO,      // Usa automaticamente la scheda video (WebGL) se disponibile, altrimenti Canvas.
        width: 800,             // Larghezza dello schermo in pixel.
        height: 600,            // Altezza dello schermo in pixel.
        physics: {
            default: 'arcade',  // 'Arcade' è un motore fisico semplice (gestisce rettangoli e cerchi).
            arcade: {
                gravity: { y: 300 }, // Gravità: tira gli oggetti verso il basso (Y positiva).
                debug: false         // Se impostato su 'true', vedresti i bordi verdi dei "corpi" fisici.
            }
        },
        scene: {                // I tre "capitoli" del ciclo di vita del gioco.
            preload: preload,   // 1. Caricamento file (immagini/suoni).
            create: create,     // 2. Creazione del mondo (eseguito una volta).
            update: update      // 3. Logica in tempo reale (eseguito 60 volte al secondo).
        }
    };

    // --- 2. IL MAGAZZINO (VARIABILI) ---
    // Definiamo le variabili qui fuori così tutte le funzioni possono "vederle".
    var player;
    var platforms;
    var cursors;
    var stars;
    var score = 0;      // Punteggio iniziale.
    var scoreText;      // La variabile che conterrà il testo del punteggio a schermo.

    // Creiamo l'istanza del gioco usando la configurazione sopra.
    var game = new Phaser.Game(config);

    // --- 3. PRELOAD (CARICAMENTO RISORSE) ---
    function preload () {
        // Diamo un soprannome a ogni immagine (es. 'sky') per usarla facilmente dopo.
        this.load.image('sky', 'assets/sky.png');
        this.load.image('ground', 'assets/platform.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('bomb', 'assets/bomb.png');
        
        // Uno spritesheet contiene più fotogrammi. Diciamo che ogni frame è 32x48 pixel.
        this.load.spritesheet('dude', 'assets/dude.png', { frameWidth: 32, frameHeight: 48 });
    }

    // --- 4. CREATE (COSTRUZIONE DEL MONDO) ---
    function create () {
        // Lo sfondo: (400, 300) è il centro dello schermo.
        this.add.image(400, 300, 'sky');

        // --- PIATTAFORME ---
        // Un 'Static Group' serve per oggetti che non si muovono mai (pavimenti e muri).
        platforms = this.physics.add.staticGroup();

        // Il pavimento principale: lo scaliamo x2 per coprire tutta la larghezza.
        // refreshBody() è FONDAMENTALE: aggiorna la fisica dopo aver cambiato la dimensione.
        platforms.create(400, 568, 'ground').setScale(2).refreshBody();

        // Creiamo le altre piattaforme sospese.
        platforms.create(600, 400, 'ground');
        platforms.create(50, 250, 'ground');
        platforms.create(750, 220, 'ground');

        // Testo del punteggio: coordinate (16, 16), testo iniziale, stile.
        scoreText = this.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

        // --- IL GIOCATORE ---
        // Aggiungiamo il personaggio con la fisica dinamica (subisce la gravità).
        player = this.physics.add.sprite(100, 450, 'dude');

        // Rimbalzo: 0.2 significa che rimbalza leggermente quando tocca terra.
        player.setBounce(0.2);
        
        // Impedisce al giocatore di uscire dai bordi del gioco.
        player.setCollideWorldBounds(true);

        // --- ANIMAZIONI ---
        // Definiamo i movimenti usando i frame dello spritesheet.
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
            frameRate: 10,
            repeat: -1 // -1 significa "ripeti all'infinito".
        });

        this.anims.create({
            key: 'turn',
            frames: [ { key: 'dude', frame: 4 } ], // Frame 4 è il giocatore che guarda avanti.
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
            frameRate: 10,
            repeat: -1
        });

        // --- INPUT ---
        // Crea automaticamente i riferimenti ai tasti freccia.
        cursors = this.input.keyboard.createCursorKeys();

        // --- STELLE ---
        // Creiamo un gruppo di 12 stelle (1 iniziale + 11 ripetizioni).
        stars = this.physics.add.group({
            key: 'star',
            repeat: 11,
            setXY: { x: 12, y: 0, stepX: 70 } // Le posiziona a distanza di 70px l'una dall'altra.
        });

        // Facciamo in modo che ogni stella rimbalzi in modo diverso (più naturale).
        stars.children.iterate(function (child) {
            child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
        });

        // --- REGOLE FISICHE (COLLISIONI) ---
        // Senza queste linee, giocatore e stelle cadrebbero attraverso le piattaforme!
        this.physics.add.collider(player, platforms);
        this.physics.add.collider(stars, platforms);

        // 'Overlap' controlla se il giocatore tocca una stella senza "sbatterci" contro.
        // Se si toccano, viene eseguita la funzione 'collectStar'.
        this.physics.add.overlap(player, stars, collectStar, null, this);
    }

    // --- 5. UPDATE (IL CICLO DI GIOCO) ---
    function update () {
        // Controlla costantemente se i tasti sono premuti.
        
        if (cursors.left.isDown) {
            player.setVelocityX(-160);       // Velocità negativa = vai a sinistra.
            player.anims.play('left', true); // Esegui animazione camminata sinistra.
        } 
        else if (cursors.right.isDown) {
            player.setVelocityX(160);        // Velocità positiva = vai a destra.
            player.anims.play('right', true);
        } 
        else {
            player.setVelocityX(0);          // Se non premi nulla, fermati.
            player.anims.play('turn');       // Guarda verso lo schermo.
        }

        // Salto: il giocatore può saltare solo se tocca il pavimento (touching.down).
        if (cursors.up.isDown && player.body.touching.down) {
            player.setVelocityY(-320); // Velocità Y negativa = vai verso l'ALTO.
        }
    }

    // --- 6. AZIONI PERSONALIZZATE ---
    // Funzione chiamata quando il giocatore raccoglie una stella.
    function collectStar (player, star) {
        // Rimuove la stella dal gioco (la nasconde e disattiva la fisica).
        star.disableBody(true, true);

        // Aumenta il punteggio di 10 e aggiorna il testo a video.
        score += 10;
        scoreText.setText('Score: ' + score);
    }

</script>

</body>
</html>